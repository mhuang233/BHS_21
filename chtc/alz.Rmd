---
title: "Analysis for CHTC simulatoin studies"
output: 
  html_document: 
    number_sections: yes
    toc: true
    toc_float: true
    code_folding: hide
editor_options: 
  chunk_output_type: inline
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
  library(data.table)
  library(rstanarm)
  library(rstan)
  library(parallel)
  library(xtable)
  library(ggplot2)
  library(ggthemes)
  library(kableExtra)
  library(LaplacesDemon)
  library(abind)
  library(dplyr)
  library(stringr)
  library(tidyverse)
```

# Functions

```{r}
# functions
alz <- function(ni, nj, icc, sigma){
a <- list.files(pattern = paste0(ni, "_", nj, "_icc", icc, "_sigma", sigma, "_out.RData"), full.names = T)  %>% map(~ mget(load(.))) 


for (i in 1:100){
  
  b <- a[[i]][1] %>% as.data.frame() 
  names(b) <- sub(pattern = ".*_ws.", replacement = "", x = names(b))
  assign(paste0("ws_", i, "_", ni, "_", nj, "_icc", icc, "_sigma", sigma), b)
  
  c <- a[[i]][2] %>% as.data.frame() %>% t()
  assign(paste0("kld_", i, "_", ni, "_", nj, "_icc", icc, "_sigma", sigma), c)
  
  d <- a[[i]][3] %>% as.data.frame() 
  names(d) <- sub(pattern = ".*.time_", replacement = "", x = names(d))
  assign(paste0("time_", i, "_", ni, "_", nj, "_icc", icc, "_sigma", sigma), d)

}

#  mean
ws <- mget(intersect(ls(pattern = paste0("ws_")), ls(pattern = paste0(ni, "_", nj, "_icc", icc, "_sigma", sigma))))%>%
      abind(along = 3)

ws_mean <- ws %>% apply(., 1:2, mean) %>% round(3)
ws_sd <- ws %>% apply(., 1:2, sd) %>% round(3)

assign(paste0("ws_all_mean", ni, "_", nj, "_icc", "_sigma", sigma), ws_mean)
assign(paste0("ws_all_sd", ni, "_", nj, "_icc", "_sigma", sigma), ws_sd)

klds <- mget(intersect(ls(pattern = paste0("kld_")), ls(pattern = paste0(ni, "_", nj, "_icc", icc, "_sigma", sigma))))%>%
      abind(along = 3)

kld_mean <- klds %>% apply(., 1:2, mean) %>% round(3)
kld_sd <- klds %>% apply(., 1:2, sd) %>% round(3)

assign(paste0("kld_all_mean", ni, "_", nj, "_icc", icc, "_sigma", sigma), kld_mean)
assign(paste0("kld_all_sd", ni, "_", nj, "_icc", icc, "_sigma", sigma), kld_sd)

times <- mget(intersect(ls(pattern = paste0("time_")), ls(pattern = paste0(ni, "_", nj, "_icc", icc, "_sigma", sigma))))%>%
      abind(along = 3)
time_mean <- times %>% apply(., 1:2, mean) %>% round(3)
# time_sd <- times %>% apply(., 1:2, sd)

assign(paste0("time_all_mean", ni, "_", nj, "_icc", icc, "_sigma", sigma), time_mean[1, ])
# assign(paste0("time_all_sd", ni, "_", nj, "_icc", icc, "_sigma", sigma), time_sd)

out <- list("ws_mean" = ws_mean, "ws_sd" = ws_sd, 
            "kld_mean" = kld_mean, "kld_sd" = kld_sd, "time_mean" = time_mean[1, ])
return(out)

}


```


# run

```{r}
icc <- c(0.1, 0.2, 0.3)
sigma <- c(0, 1, 5)
ni = c(50, 150)
nj = c(10, 30)

# sigma = 0
alz(ni = 50, nj = 10, icc = 0.1, sigma = 0)
alz(ni = 150, nj = 30, icc = 0.1, sigma = 0)

alz(ni = 50, nj = 10, icc = 0.2, sigma = 0)
alz(ni = 150, nj = 30, icc = 0.2, sigma = 0)

alz(ni = 50, nj = 10, icc = 0.3, sigma = 0)
alz(ni = 150, nj = 30, icc = 0.3, sigma = 0)

# sigma = 1
alz(ni = 50, nj = 10, icc = 0.1, sigma = 1)
alz(ni = 150, nj = 30, icc = 0.1, sigma = 1)

alz(ni = 50, nj = 10, icc = 0.2, sigma = 1)
alz(ni = 150, nj = 30, icc = 0.2, sigma = 1)

alz(ni = 50, nj = 10, icc = 0.3, sigma = 1)
alz(ni = 150, nj = 30, icc = 0.3, sigma = 1)


# sigma = 5
alz(ni = 50, nj = 10, icc = 0.1, sigma = 5)
alz(ni = 150, nj = 30, icc = 0.1, sigma = 5)

alz(ni = 50, nj = 10, icc = 0.2, sigma = 5)
alz(ni = 150, nj = 30, icc = 0.2, sigma = 5)

alz(ni = 50, nj = 10, icc = 0.3, sigma = 5)
alz(ni = 150, nj = 30, icc = 0.3, sigma = 5)


```



